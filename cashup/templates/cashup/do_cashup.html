{% extends 'manage_orders/index.html' %}
{% block title %}Cash-up{% endblock %}
{% block content %}
<div class="container py-3">
  <h2>Cash-up</h2>
  <form method="post" class="mt-3">{% csrf_token %}
    <div class="row g-3">
      <div class="col-md-6">
        <div class="mb-3">{{ form.expected_amount.label_tag }} {{ form.expected_amount }}</div>
        <div class="mb-3">{{ form.notes.label_tag }} {{ form.notes }}</div>
        <div class="alert alert-secondary" id="calc-panel">
          <div>Actual total: <strong id="actual-total">£0.00</strong></div>
          <div>Difference (Actual - Expected): <strong id="diff-total">£0.00</strong></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">Counts</div>
          <div class="card-body">
            {% for d in denoms %}
              <div class="row align-items-center mb-2">
                <div class="col">{{ d.name }} (£{{ d.value }})</div>
                <div class="col-auto">
                  <div class="input-group">
                    <span class="input-group-text">£</span>
                    <input type="number" step="0.01" class="form-control denom-amount-input" min="0" value="0"
                      id="denom_amount_{{ d.pk }}"
                      data-value="{{ d.value }}"
                      data-value-pence="{{ d.value|floatformat:2|cut:'.' }}"
                      aria-describedby="denom_help_{{ d.pk }}">
                  </div>
                  <!-- Hidden original count field preserved for backend -->
                  <input type="hidden" name="denom_{{ d.pk }}" id="denom_count_{{ d.pk }}" value="0">
                  <small id="denom_help_{{ d.pk }}" class="text-muted">Count: <span class="denom-count" data-denom="{{ d.pk }}">0</span></small>
                </div>
              </div>
            {% empty %}
              <div class="text-muted">No denominations defined.</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
    <div class="mt-3">
      <button class="btn btn-primary">Save Cash-up</button>
      <a class="btn btn-secondary" href="{% url 'cashup:index' %}">Back</a>
    </div>
  </form>
</div>
<script>
(function(){
  function parsePoundsToPence(txt){
    const n = parseFloat(String(txt||'0'));
    if(isNaN(n)) return 0;
    return Math.round(n*100);
  }
  function money(pence){ return '£' + (pence/100).toFixed(2); }
  function recalc(){
    let actualP = 0;
    document.querySelectorAll('.denom-amount-input').forEach(inp=>{
      const pv = inp.getAttribute('data-value-pence');
      let denomP = 0;
      if(pv !== null && pv !== ''){
        denomP = parseInt(pv, 10) || 0;
      } else {
        const valStr = inp.getAttribute('data-value');
        const val = parseFloat(valStr);
        denomP = Math.round((isNaN(val)?0:val)*100);
      }
      const amountEnteredP = parsePoundsToPence(inp.value);
      actualP += amountEnteredP;
      // Compute count
      let countDisplay = '0';
      let isValid = true;
      if(denomP > 0){
        if(amountEnteredP === 0){
          countDisplay = '0';
        } else if(amountEnteredP % denomP === 0){
          countDisplay = String(amountEnteredP / denomP);
        } else {
          // Non-integer number of notes/coins
          const rawCount = amountEnteredP / denomP;
          countDisplay = rawCount.toFixed(2);
          isValid = false;
        }
      }
      const denomId = inp.id.replace('denom_amount_','');
      const countSpan = document.querySelector('.denom-count[data-denom="'+denomId+'"]');
      if(countSpan) countSpan.textContent = countDisplay;
      const hiddenCount = document.getElementById('denom_count_'+denomId);
      if(hiddenCount){
        // Store integer rounded count (floor) to backend; if invalid keep floor
        hiddenCount.value = denomP>0 ? Math.floor(amountEnteredP/denomP) : 0;
      }
      inp.classList.toggle('is-invalid', !isValid);
    });
    const expectedInp = document.getElementById('id_expected_amount');
    const expectedP = expectedInp ? parsePoundsToPence(expectedInp.value) : 0;
    const diffP = actualP - expectedP;
    const aEl = document.getElementById('actual-total');
    const dEl = document.getElementById('diff-total');
    if(aEl) aEl.textContent = money(actualP);
    if(dEl) dEl.textContent = money(diffP);
  }
  document.addEventListener('input', (e)=>{
    if(e.target.matches('.denom-amount-input') || e.target.id==='id_expected_amount') recalc();
  });
  recalc();
})();
</script>
{% endblock %}
