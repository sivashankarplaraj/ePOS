{% extends 'manage_orders/index.html' %}
{% load static %}
{% block content %}
<h5 class="mt-3">Create Order</h5>
<!-- Price Band Selector (Buttons) -->
<div class="mb-3">
  <label class="form-label fw-semibold">Select Price Band</label>
  <div id="band-buttons" class="d-flex flex-wrap gap-2">
    <button type="button" class="btn btn-outline-primary btn-lg px-4 py-3 active" data-band="1">Band-1</button>
    <button type="button" class="btn btn-outline-primary btn-lg px-4 py-3" data-band="2">Band-2</button>
    <button type="button" class="btn btn-outline-primary btn-lg px-4 py-3" data-band="3">Band-3</button>
    <button type="button" class="btn btn-outline-primary btn-lg px-4 py-3" data-band="4">Band-4</button>
    <button type="button" class="btn btn-outline-primary btn-lg px-4 py-3" data-band="5">Band-5</button>
    <button type="button" class="btn btn-outline-primary btn-lg px-4 py-3" data-band="6">Band-6</button>
  </div>
    <div class="form-check mt-2">
      <input class="form-check-input" type="checkbox" id="toggle-net" />
      <label class="form-check-label" for="toggle-net">Show Net (Ex VAT) Prices</label>
    </div>
      
      <div class="mt-2">
        <label class="form-label small mb-1">VAT Basis</label>
        <div id="basis-buttons" class="d-flex gap-2 flex-wrap">
          <button type="button" class="btn btn-outline-info btn-lg px-3 py-2 active" data-basis="take">Takeaway</button>
          <button type="button" class="btn btn-outline-info btn-lg px-3 py-2" data-basis="eat">Eat-in</button>
        </div>
      </div>
</div>
<!-- Categories below Price Band (horizontal scroll) -->
<div id="categories-section" class="mb-3">
  <div class="fw-semibold small text-uppercase text-secondary mb-2">Categories</div>
  <div id="category-strip" class="d-flex flex-nowrap overflow-auto gap-3 py-3" style="font-size:1.35rem; -webkit-overflow-scrolling: touch;"></div>
</div>

<!-- Main layout: Items (70%) | Basket (30%) -->
<div class="row" id="order-workspace">
  <div class="col-12 col-lg-9" id="items-pane" style="max-height:70vh; overflow:auto;">
    <div class="fw-semibold small text-uppercase text-secondary mb-2">Items</div>
    <div id="items-container" class="row g-3">
      <!-- Items injected via JS -->
    </div>
  </div>
  <div class="col-12 col-lg-3 border-start" id="basket-pane" style="max-height:70vh; overflow:auto;">
    <div class="fw-semibold small text-uppercase text-secondary mb-2">Basket</div>
    <ul class="list-group" id="basket-list" style="font-size:1.15rem;"></ul>
    <div class="mt-3 d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Total</span>
      <span id="basket-total" class="fs-5">£0.00</span>
    </div>
    <div class="mt-4 text-end">
      <button class="btn btn-lg btn-outline-secondary px-4 py-2 me-2" id="clear-basket" disabled>Clear</button>
      <button class="btn btn-lg btn-primary px-4 py-2" id="checkout" disabled>Checkout</button>
    </div>
  </div>
</div>
<!-- Checkout Modal -->
<div class="modal fade" id="checkoutModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header py-3">
        <h5 class="modal-title fs-3 fw-bold">Confirm Checkout</h5>
        <button type="button" class="btn-close btn-lg" style="transform:scale(1.3);" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-semibold" for="pay-method" style="font-size:1.1rem;">Payment Method</label>
          <select id="pay-method" class="form-select form-select-lg py-3" style="font-size:1.15rem;">
            <option>Cash</option>
            <option>Card</option>
            <option>On Account</option>
            <option>Voucher</option>
            <option>Paid Out</option>
            <option>Crew Food</option>
            <option>Waste food</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label fw-semibold" for="crew-id" style="font-size:1.1rem;">Crew ID</label>
          <input id="crew-id" class="form-control form-control-lg py-3" style="font-size:1.15rem;" type="text" inputmode="numeric" placeholder="0" value="0" />
          <div id="crew-id-error" class="text-danger small mt-1 d-none">Crew ID is required</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-lg btn-outline-secondary px-4 py-2" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-lg btn-primary px-4 py-2 fw-bold" id="confirm-checkout">Confirm</button>
      </div>
    </div>
  </div>
  </div>
<!-- Item Configuration Modal -->
<div class="modal fade" id="itemConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header py-3">
        <h5 class="modal-title fs-3 fw-bold" id="cfg-title">Configure Item</h5>
        <button type="button" class="btn-close btn-lg" style="transform:scale(1.3);" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="cfg-loading" class="text-center py-5">Loading...</div>
        <div id="cfg-body" class="d-none">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
              <div>
                <strong id="cfg-item-name"></strong>
                <span class="badge bg-secondary ms-2 d-none" id="cfg-item-type">Combo</span>
                <span class="badge bg-info text-dark ms-2 d-none" id="cfg-meal-badge">Meal</span>
              </div>
              <div class="text-end small">
                <div>Band <span id="cfg-band"></span></div>
                <div class="d-flex flex-column">
                  <div>Price: <span id="cfg-price-main"></span><span id="cfg-meal-price" class="ms-2 small text-info"></span></div>
                  <div class="small" id="cfg-price-note"></div>
                </div>
              </div>
            </div>
          </div>
          <!-- Config Tabs: Extras appears only when options/choices exist -->
          <div class="mb-3 d-flex gap-2" id="cfg-tabbar">
            <button type="button" class="btn btn-outline-secondary btn-lg px-3 py-2 active" data-cfg-tab="main">Configure</button>
            <button type="button" class="btn btn-outline-secondary btn-lg px-3 py-2 d-none" id="cfg-extras-tab" data-cfg-tab="extras">Extras</button>
          </div>
          <div id="cfg-variants" class="mb-4 d-none">
            <label class="form-label fw-semibold" style="font-size:1.15rem;">Variants</label>
            <div id="cfg-variant-list" class="d-flex flex-wrap gap-3"></div>
          </div>
          <div id="cfg-meal-section" class="border rounded p-3 mb-4 d-none" style="background:var(--bs-tertiary-bg);">
            <div class="form-check form-switch mb-3" style="font-size:1.15rem;">
              <input class="form-check-input" style="width:3rem;height:1.5rem;" type="checkbox" id="cfg-meal-toggle" />
              <label class="form-check-label ms-2" for="cfg-meal-toggle">Convert to Meal</label>
            </div>
            <div id="cfg-meal-components" class="row g-3 d-none">
              <div class="col-md-6 d-none" id="cfg-fries-wrap">
                <label class="form-label fw-semibold" style="font-size:1.05rem;">Fries</label>
                <select id="cfg-fries" class="form-select form-select-lg py-3" style="font-size:1.15rem;"></select>
              </div>
              <div class="col-md-6" id="cfg-drinks-wrap">
                <label class="form-label fw-semibold" style="font-size:1.05rem;">Drink</label>
                <div id="cfg-drink-list" class="d-flex flex-wrap gap-2"></div>
              </div>
            </div>
            <div class="form-check form-switch mt-2 d-none" id="cfg-go-large-wrap" style="font-size:1.05rem;">
              <input class="form-check-input" style="width:3rem;height:1.5rem;" type="checkbox" id="cfg-go-large" />
              <label class="form-check-label ms-2" for="cfg-go-large">Go Large</label>
            </div>
          </div>
          <div id="cfg-options" class="mb-4 d-none">
            <label class="form-label fw-semibold" style="font-size:1.15rem;">Optional Products</label>
            <div id="cfg-options-list" class="d-flex flex-column gap-2" style="font-size:1.05rem;"></div>
          </div>
          <div id="cfg-combo-structure" class="mb-4 d-none">
            <label class="form-label fw-semibold" style="font-size:1.15rem;">Combination Components</label>
            <div class="row g-2">
              <div class="col-md-6">
                <div class="border rounded p-3 h-100" style="font-size:1.05rem;">
                  <div class="fw-semibold mb-2" style="font-size:1.05rem;">Compulsory</div>
                  <ul id="cfg-compulsory" class="mb-0 list-unstyled"></ul>
                </div>
              </div>
              <div class="col-md-6">
                <div class="border rounded p-3 h-100" style="font-size:1.05rem;">
                  <div class="fw-semibold mb-2" style="font-size:1.05rem;">Optional <span class="text-muted" id="cfg-free-optional"></span></div>
                  <div id="cfg-optional" class="d-flex flex-column gap-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-lg btn-outline-secondary px-4 py-2" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-lg btn-primary px-4 py-2 fw-bold" id="cfg-add-btn" disabled>Add to Basket</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const bandButtonsWrap = document.getElementById('band-buttons');
  const basisButtonsWrap = document.getElementById('basis-buttons');
  const categoryStrip = document.getElementById('category-strip');
  const itemsContainer = document.getElementById('items-container');
  const basketList = document.getElementById('basket-list');
  const basketTotal = document.getElementById('basket-total');
  const clearBtn = document.getElementById('clear-basket');
  const checkoutBtn = document.getElementById('checkout');
  let currentBand = '1';
  let vatBasis = 'take'; // default
  let showNet = false;
  // Lightweight data flow: fetch categories first, then items per selected category.
  let categories = [];
  const catItemsCache = {}; // { [catId]: items[] }
  let currentItems = [];
  let activeCategoryId = null;

  const basket = { lines:[], total:0 };

  // Modal / config state
  const cfgModalEl = document.getElementById('itemConfigModal');
  let cfgModal = null; const ensureModal=()=>{ if(!cfgModal) cfgModal = new bootstrap.Modal(cfgModalEl); };
  const cfg = { data:null, currentVariant:null, meal:false, fries:null, drink:null, optionalSelected:new Set(), effectivePrice:0 };
  let cfgTab = 'main';

  function money(pence){ return '£' + (pence/100).toFixed(2); }

  // Deterministic, subtle color accents per item (improves scannability without harming contrast)
  function colorAccentForItem(prod){
    const s = String(prod.code ?? prod.name ?? '');
    let hash = 0;
    for(let i=0;i<s.length;i++){ hash = ((hash << 5) - hash) + s.charCodeAt(i); hash |= 0; }
    const hue = Math.abs(hash) % 360; // stable hue per item
    // Light theme: pastel bg + medium border. Dark theme: translucent tint + lighter border.
    const bgLight = `hsl(${hue}, 85%, 97%)`;
    const borderLight = `hsl(${hue}, 65%, 45%)`;
    const bgDark = `hsla(${hue}, 80%, 60%, 0.08)`;
    const borderDark = `hsl(${hue}, 70%, 60%)`;
    return { bgLight, borderLight, bgDark, borderDark };
  }

  function isDarkTheme(){
    const attr = document.documentElement.getAttribute('data-bs-theme');
    if(attr){ return attr.toLowerCase() === 'dark'; }
    return !!(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
  }

  function fetchMenu(){
    // Reset caches when band changes
    categories = [];
    currentItems = [];
    for(const k of Object.keys(catItemsCache)) delete catItemsCache[k];
    itemsContainer.innerHTML='';
    categoryStrip.innerHTML='<div class="text-muted small">Loading...</div>';
    fetch(`/api/menu/categories?band=${currentBand}`)
      .then(r=>r.json())
      .then(data=>{ categories = data.categories || []; renderCategories(); autoSelectFirst(); })
      .catch(err=>{ console.error('Categories load error', err); categoryStrip.innerHTML='<div class="text-danger small">Failed to load</div>'; });
  }

  function renderCategories(){
    categoryStrip.innerHTML='';
    (categories||[]).forEach(cat=>{
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline-secondary';
      btn.textContent = cat.name + (cat.item_count? ` (${cat.item_count})` : '');
      btn.dataset.catId = cat.id;
      if(cat.id === activeCategoryId) btn.classList.add('active');
      btn.addEventListener('click', ()=>{ selectCategory(cat.id); });
      categoryStrip.appendChild(btn);
    });
  }

  function autoSelectFirst(){
    if(!activeCategoryId && (categories||[]).length){
      selectCategory(categories[0].id);
    } else if(activeCategoryId){
      selectCategory(activeCategoryId);
    }
  }

  function selectCategory(catId){
    activeCategoryId = catId;
    renderCategories();
    itemsContainer.innerHTML = '<div class="text-muted small">Loading items...</div>';
    if(catItemsCache[catId]){
      currentItems = catItemsCache[catId];
      renderProducts();
      return;
    }
    fetch(`/api/menu/category/${catId}/items?band=${currentBand}`)
      .then(r=>r.json())
      .then(data=>{ currentItems = data.items || []; catItemsCache[catId] = currentItems; renderProducts(); })
      .catch(err=>{ console.error('Items load error', err); itemsContainer.innerHTML='<div class="text-danger small">Failed to load items</div>'; });
  }

  function priceForDisplay(prod){
    if(showNet){ return vatBasis==='eat'? prod.price_net_eat : prod.price_net_take; }
    return prod.price_gross;
  }

  function priceForDiscountDisplay(prod){
    if(showNet){ return vatBasis==='eat'? prod.discounted_price_net_eat : prod.discounted_price_net_take; }
    return prod.discounted_price_gross;
  }

  function renderProducts(){
    itemsContainer.innerHTML='';
    if(!currentItems || currentItems.length===0){ return; }
    currentItems.forEach(prod=>{
      const col = document.createElement('div');
      col.className='col-6 col-md-4 col-xl-3';
  const card = document.createElement('div'); card.className='card h-100 shadow-sm';
  // Apply subtle color accents per item (left border + theme-aware background)
  const acc = colorAccentForItem(prod);
  const dark = isDarkTheme();
  card.style.borderLeft = `6px solid ${dark ? acc.borderDark : acc.borderLight}`;
  card.style.backgroundColor = dark ? acc.bgDark : acc.bgLight;
      // Make card the click target
      card.setAttribute('data-open', String(prod.code));
      card.setAttribute('data-item-type', prod.type);
      card.style.cursor = 'pointer';
      const basePrice = priceForDisplay(prod);
  const priceHtml = `<span class='fs-5 fw-bold'>${money(basePrice)}</span>${showNet? ' <span class=\"text-muted small\">ex VAT</span>':''}`;
      const mealBadge = prod.meal_flag ? " <span class='badge bg-info text-dark'>Meal</span>" : '';
      const discountHtml = prod.has_discount ? ` <span class='badge bg-warning text-dark'>Meal ${money(priceForDiscountDisplay(prod))}</span>` : '';
      let variantsHtml='';
      if(prod.variants && prod.variants.length){
        variantsHtml = `<div class='mt-1 small d-flex flex-wrap gap-1'>` + prod.variants.map(v=>{
          return `<span class='badge text-bg-light' role='button' data-var='${v.code}' data-parent='${prod.code}' data-item-type='product' title='${v.label}'>${v.label}: ${money(v.price_gross)}</span>`; }).join('') + `</div>`;
      }
      card.innerHTML = `<div class=\"card-body d-flex flex-column\">
        <h6 class=\"card-title mb-1 text-truncate\" title=\"${prod.name}\">${prod.name}${mealBadge}</h6>
        <div class=\"small text-muted mb-2\">#${prod.code} ${prod.type==='combo'?'<span class=\"badge bg-secondary\">Combo</span>':''}</div>
        <div class=\"fw-semibold mb-2\">${priceHtml}${discountHtml}</div>
  ${variantsHtml}
  <div class="mt-auto"></div>
      </div>`;
      col.appendChild(card); itemsContainer.appendChild(col);
    });
  }

  function findItem(type, code){
    // Search current items first, then any cached category
    for(const it of (currentItems||[])){ if(it.type===type && it.code==code) return it; }
    for(const catId of Object.keys(catItemsCache)){
      const arr = catItemsCache[catId] || [];
      for(const it of arr){ if(it.type===type && it.code==code) return it; }
    }
    return null;
  }

  function addLine(line){
    // Compute a signature so we only merge identical configuration (code, variant, meal, choices)
    const sig = createLineSignature(line);
    line.signature = sig;
    const existing = basket.lines.find(l=> l.signature === sig);
    if(existing){ existing.qty = (existing.qty||1)+ (line.qty||1); }
    else basket.lines.push({...line, qty: line.qty||1, signature: sig});
    renderBasket();
  }
  function createLineSignature(line){
    const meta = line.meta || {};
    const opts = (meta.options||[]).slice().sort((a,b)=>a-b).join('-');
    const fries = meta.fries || '';
    const drink = meta.drink || '';
    const variant = line.variant || '';
    return [line.code, variant, line.meal?1:0, fries, drink, opts].join('|');
  }
  function renderBasket(){
    basket.total = basket.lines.reduce((s,l)=> s + (l.price * (l.qty||1)), 0);
    basketList.innerHTML='';
    basket.lines.forEach((l,idx)=>{
      const li=document.createElement('li');
      li.className='list-group-item';
      // Build choices/details list
      let details = [];
      const meta = l.meta || {};
      if(meta.display_choices && meta.display_choices.length){
        details = meta.display_choices.map(dc=> `<li>${dc}</li>`);
      } else {
        // Legacy: derive basic details from meta codes if names not stored
        if(meta.fries) details.push(`<li>Fries: #${meta.fries}</li>`);
        if(meta.drink) details.push(`<li>Drink: #${meta.drink}</li>`);
        if(meta.options && meta.options.length){ details.push(`<li>Options: ${meta.options.map(o=>'#'+o).join(', ')}</li>`); }
      }
      const detailsHtml = details.length? `<ul class='small text-muted mb-1 ms-2 list-unstyled'>${details.join('')}</ul>` : '';
      li.innerHTML = `<div class='d-flex justify-content-between align-items-start gap-2'>
        <div class='flex-grow-1'>
          <div>${l.name}${l.variant? ' ('+l.variant+')':''}${l.meal?' Meal':''}</div>
          ${detailsHtml}
        </div>
        <div class='d-flex align-items-center gap-2'>
          <div class='btn-group btn-group-sm' role='group'>
            <button class='btn btn-outline-secondary' data-dec='${idx}'>&minus;</button>
            <span class='px-2'>${l.qty||1}</span>
            <button class='btn btn-outline-secondary' data-inc='${idx}'>&plus;</button>
          </div>
          <div class='text-end'>
            <div class='fw-semibold'>${money(l.price * (l.qty||1))}</div>
            <button class='btn btn-outline-danger mt-1 d-inline-flex align-items-center justify-content-center'
                    style='width:40px;height:40px;border-width:2px;'
                    data-del='${idx}' title='Remove' aria-label='Remove item'>
              <svg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 16 16' fill='currentColor' aria-hidden='true'>
                <path d='M5.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v7a.5.5 0 0 0 1 0v-7z'/>
                <path fill-rule='evenodd' d='M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2h4.118a1 1 0 0 1 .94.658L6.5 3h3l.442-1.342A1 1 0 0 1 10.882 2H15v1zM4.118 4 4 4v9a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4H4.118zM2.5 3V2h11v1h-11z'/>
              </svg>
            </button>
          </div>
        </div>
      </div>`;
      basketList.appendChild(li);
    });
    basketTotal.textContent = money(basket.total);
    clearBtn.disabled = basket.lines.length===0; checkoutBtn.disabled = basket.lines.length===0;
  }
  clearBtn.addEventListener('click', ()=>{ basket.lines=[]; renderBasket(); });
  // Checkout flow opens modal to collect payment method and crew ID
  let checkoutModal = null; const ensureCheckoutModal=()=>{ if(!checkoutModal){ checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal')); } };
  checkoutBtn.addEventListener('click', ()=>{ if(!basket.lines.length) return; ensureCheckoutModal(); document.getElementById('crew-id-error').classList.add('d-none'); checkoutModal.show(); });
  document.getElementById('confirm-checkout').addEventListener('click', ()=>{
    const payMethod = document.getElementById('pay-method').value;
    const crewId = (document.getElementById('crew-id').value||'').trim();
    if(crewId===''){
      document.getElementById('crew-id-error').classList.remove('d-none');
      return;
    }
    checkoutModal.hide();
    submitOrder({ payment_method: payMethod, crew_id: crewId });
  });

  itemsContainer.addEventListener('click', (e)=>{
    const variant = e.target.closest('[data-var]');
    if(variant){ openConfig('product', variant.dataset.parent, variant.dataset.var); return; }
    const openCard = e.target.closest('[data-open]');
    if(openCard){
      const type = openCard.getAttribute('data-item-type');
      const code = openCard.getAttribute('data-open');
      const base = findItem(type, code);
      const needsConfig = type==='combo' || (base && ((base.variants&&base.variants.length) || base.meal_flag || (base.options&&base.options.length)));
      if(needsConfig){ openConfig(type, code, null); }
      else if(base){ addLine({ code: base.code, name: base.name, qty:1, price: base.price_gross, type: base.type }); }
      return;
    }
  });

  basketList.addEventListener('click', (e)=>{
    const inc = e.target.closest('[data-inc]');
    if(inc){ const i=parseInt(inc.dataset.inc,10); basket.lines[i].qty++; renderBasket(); return; }
    const dec = e.target.closest('[data-dec]');
    if(dec){ const i=parseInt(dec.dataset.dec,10); basket.lines[i].qty--; if(basket.lines[i].qty<=0) basket.lines.splice(i,1); renderBasket(); return; }
    const del = e.target.closest('[data-del]');
    if(del){ const i=parseInt(del.dataset.del,10); basket.lines.splice(i,1); renderBasket(); return; }
  });

  function openConfig(type, code, preVariant){
    ensureModal();
    cfg.data=null; cfg.currentVariant=preVariant; cfg.meal=false; cfg.fries=null; cfg.drink=null; cfg.optionalSelected.clear();
    document.getElementById('cfg-loading').classList.remove('d-none');
    document.getElementById('cfg-body').classList.add('d-none');
    document.getElementById('cfg-add-btn').disabled=true;
    cfgModal.show();
    fetch(`/api/item/${type}/${code}/detail?band=${currentBand}`)
      .then(r=>r.json())
      .then(d=>{ cfg.data=d.item; populateConfig(); })
      .catch(()=>{ document.getElementById('cfg-loading').textContent='Failed to load'; });
  }

  function populateConfig(){
    const data = cfg.data; if(!data) return;
    document.getElementById('cfg-title').textContent = `Configure #${data.code}`;
    document.getElementById('cfg-item-name').textContent = data.name;
    document.getElementById('cfg-item-type').classList.toggle('d-none', data.type!=='combo');
    document.getElementById('cfg-meal-badge').classList.toggle('d-none', !data.meal_flag);
    document.getElementById('cfg-band').textContent = currentBand;
    // Variants
    const vWrap = document.getElementById('cfg-variants');
    const vList = document.getElementById('cfg-variant-list'); vList.innerHTML='';
    if(data.variants && data.variants.length){
      vWrap.classList.remove('d-none');
      data.variants.forEach(v=>{
        const btn=document.createElement('button'); btn.type='button'; btn.className='btn btn-sm btn-outline-secondary';
        btn.textContent = `${v.label} ${money(v.price_gross)}`; btn.dataset.code=v.code;
        if(cfg.currentVariant && cfg.currentVariant==v.code) btn.classList.add('active');
        btn.addEventListener('click',()=>{ cfg.currentVariant=v.code; [...vList.children].forEach(c=>c.classList.remove('active')); btn.classList.add('active'); updateConfigPrice(); });
        vList.appendChild(btn);
      });
    } else vWrap.classList.add('d-none');
    // Meal
    const mealSection = document.getElementById('cfg-meal-section');
    const mealToggle = document.getElementById('cfg-meal-toggle');
    const mealComp = document.getElementById('cfg-meal-components');
  const friesSel = document.getElementById('cfg-fries');
  const drinkList = document.getElementById('cfg-drink-list'); friesSel.innerHTML=''; if(drinkList) drinkList.innerHTML='';
    const goLargeWrap = document.getElementById('cfg-go-large-wrap');
    const goLargeToggle = document.getElementById('cfg-go-large');
    const friesWrap = document.getElementById('cfg-fries-wrap');
    const drinksWrap = document.getElementById('cfg-drinks-wrap');
    if(data.meal_flag && data.meal_components && data.meal_components.fries && data.meal_components.fries.length){
      mealSection.classList.remove('d-none');
      mealToggle.checked=false; mealComp.classList.add('d-none');
      goLargeWrap.classList.add('d-none'); goLargeToggle.checked=false;
      friesWrap.classList.add('d-none');
      // Populate fries (we'll auto-select regular when toggle on)
      const friesList = (data.meal_components.fries||[]);
      friesList.forEach(f=>{ const o=document.createElement('option'); o.value=f.code; o.textContent=`${f.name} ${money(f.price_gross)}`; friesSel.appendChild(o); });
      // Filter drinks: only regular where T_DRINK_CD > 0
      let regularDrinks = (data.meal_components.drinks||[]).filter(d=> (d.T_DRINK_CD||d.t_drink_cd||0) > 0);
      if(regularDrinks.length===0){ regularDrinks = (data.meal_components.drinks||[]); }
      // Render drink buttons (no price)
      if(drinkList){
        drinkList.innerHTML='';
        regularDrinks.forEach(dr=>{
          const b=document.createElement('button'); b.type='button'; b.className='btn btn-outline-info';
          b.textContent = dr.name; b.dataset.code = dr.code; b.dataset.tDrinkCd = dr.T_DRINK_CD || dr.t_drink_cd || 0;
          b.addEventListener('click', ()=>{
            cfg.drink = parseInt(b.dataset.code,10);
            // toggle active state
            [...drinkList.children].forEach(c=> c.classList.remove('active'));
            b.classList.add('active');
            updateConfigPrice();
          });
          drinkList.appendChild(b);
        });
      }
      // Defaults when toggled on: select first regular fries and require a drink choice
  friesSel.selectedIndex = -1; cfg.fries=null; cfg.drink=null;
      mealToggle.onchange=()=>{
        cfg.meal=mealToggle.checked;
        mealComp.classList.toggle('d-none', !cfg.meal);
        goLargeWrap.classList.toggle('d-none', !cfg.meal);
        if(cfg.meal){
          // Auto-select regular fries (assume first option is Regular)
          if(friesSel.options.length>0){ friesSel.selectedIndex=0; cfg.fries=parseInt(friesSel.value,10); }
        } else {
          cfg.fries=null; cfg.drink=null; goLargeToggle.checked=false;
        }
        updateConfigPrice();
      };
      friesSel.onchange=()=>{ cfg.fries=friesSel.value? parseInt(friesSel.value,10):null; updateConfigPrice(); };
  // drink selection handled via buttons above
      goLargeToggle.onchange=()=>{ updateConfigPrice(); };
    } else mealSection.classList.add('d-none');
    // Product options
    const optWrap = document.getElementById('cfg-options');
    const optList = document.getElementById('cfg-options-list'); optList.innerHTML='';
    const renderProductOptions = ()=>{
      optList.innerHTML='';
      if(data.options && data.options.length){
        optWrap.classList.remove('d-none');
        data.options.forEach(o=>{
          const id=`opt-prod-${o.code}`;
    optList.insertAdjacentHTML('beforeend', `<div class='form-check form-check-inline'><input class='form-check-input' type='checkbox' id='${id}' data-opt-code='${o.code}'><label class='form-check-label small' for='${id}'>${o.name} ${money(o.price_gross||0)}</label></div>`);
        });
      } else {
        optWrap.classList.add('d-none');
      }
    };
    renderProductOptions();
    optList.addEventListener('change', e=>{
      const cb=e.target.closest('[data-opt-code]');
      if(cb){
        const code=parseInt(cb.dataset.optCode,10);
        if(cb.checked) cfg.optionalSelected.add(code); else cfg.optionalSelected.delete(code);
        updateConfigPrice();
      }
    });
    // Fallback: If product options missing in detail payload, fetch via API and render
    if(data.type==='product' && (!data.options || data.options.length===0)){
      fetch(`/api/product/${data.code}/options?band=${currentBand}`)
        .then(r=>r.json())
        .then(resp=>{
          if(resp && Array.isArray(resp.options) && resp.options.length){
            data.options = resp.options.map(o=>({ code:o.code, name:o.name, price_gross:o.price_gross }));
            renderProductOptions();
            const extrasTabBtn = document.getElementById('cfg-extras-tab');
            if(extrasTabBtn){ extrasTabBtn.classList.toggle('d-none', false); }
            syncConfigTabs();
          }
        })
        .catch(()=>{});
    }
    // Combo structure
    const comboStruct = document.getElementById('cfg-combo-structure');
    const compUL = document.getElementById('cfg-compulsory');
    const optDiv = document.getElementById('cfg-optional');
    const freeLbl = document.getElementById('cfg-free-optional'); compUL.innerHTML=''; optDiv.innerHTML='';
    if(data.type==='combo'){
      comboStruct.classList.remove('d-none');
      (data.compulsory||[]).forEach(c=>{ compUL.insertAdjacentHTML('beforeend', `<li>${c.name} ${money(c.price_gross)}</li>`); });
      if(data.optional && data.optional.length){
        freeLbl.textContent = data.free_optional_count? `(First ${data.free_optional_count} free)` : '';
        data.optional.forEach(o=>{
          const id=`opt-combo-${o.code}`;
          optDiv.insertAdjacentHTML('beforeend', `<div class='form-check'><input class='form-check-input' type='checkbox' id='${id}' data-combo-opt='${o.code}'><label class='form-check-label small' for='${id}'>${o.name} ${money(o.price_gross)}</label></div>`);
        });
        optDiv.addEventListener('change', e=>{ const cb=e.target.closest('[data-combo-opt]'); if(cb){ const code=parseInt(cb.dataset.comboOpt,10); if(cb.checked) cfg.optionalSelected.add(code); else cfg.optionalSelected.delete(code); updateConfigPrice(); }});
      }
    } else comboStruct.classList.add('d-none');

    // Extras tab visibility (show when product choices or combo optionals exist)
    const extrasTabBtn = document.getElementById('cfg-extras-tab');
    const hasExtras = (data.options && data.options.length) || (data.type==='combo' && data.optional && data.optional.length);
    if(extrasTabBtn){
      extrasTabBtn.classList.toggle('d-none', !hasExtras);
    }
    cfgTab = 'main';
    syncConfigTabs();
    updateConfigPrice();
    document.getElementById('cfg-loading').classList.add('d-none');
    document.getElementById('cfg-body').classList.remove('d-none');
    document.getElementById('cfg-add-btn').disabled=false;
  }

  function syncConfigTabs(){
    const tabbar = document.getElementById('cfg-tabbar');
    if(tabbar){
      const btns = tabbar.querySelectorAll('[data-cfg-tab]');
      btns.forEach(b=> b.classList.toggle('active', b.getAttribute('data-cfg-tab')===cfgTab));
    }
    const data = cfg.data; if(!data) return;
    const hasExtras = (data.options && data.options.length) || (data.type==='combo' && data.optional && data.optional.length);
    // Reset default visibility based on data
    const vWrap = document.getElementById('cfg-variants');
    const mealSection = document.getElementById('cfg-meal-section');
    const optWrap = document.getElementById('cfg-options');
    const comboStruct = document.getElementById('cfg-combo-structure');
    if(vWrap) vWrap.classList.toggle('d-none', !(data.variants && data.variants.length));
    const mealOkay = data.meal_flag && data.meal_components && data.meal_components.fries && data.meal_components.fries.length;
    if(mealSection) mealSection.classList.toggle('d-none', !mealOkay);
    if(optWrap) optWrap.classList.toggle('d-none', !(data.options && data.options.length));
    if(comboStruct) comboStruct.classList.toggle('d-none', data.type!=='combo');
    // If on Extras tab, focus only on extras lists
    if(hasExtras && cfgTab==='extras'){
      if(vWrap) vWrap.classList.add('d-none');
      if(mealSection) mealSection.classList.add('d-none');
      if(data.type==='combo'){
        // Hide compulsory column but keep optional side visible
        const compUL = document.getElementById('cfg-compulsory');
        const compCol = compUL ? compUL.closest('.col-md-6') : null;
        const optCol = document.getElementById('cfg-optional')?.closest('.col-md-6');
        if(compCol) compCol.classList.add('d-none');
        if(optCol) optCol.classList.remove('d-none');
        if(comboStruct) comboStruct.classList.remove('d-none');
      }
      if(optWrap) optWrap.classList.toggle('d-none', !(data.options && data.options.length));
      // On Extras tab hide product non-extras sections already handled above
    } else {
      // Configure (main) tab: show core sections, hide extras if we have a dedicated Extras tab
      const compUL = document.getElementById('cfg-compulsory');
      const compCol = compUL ? compUL.closest('.col-md-6') : null;
      const optCol = document.getElementById('cfg-optional')?.closest('.col-md-6');
      if(compCol) compCol.classList.remove('d-none');
      if(hasExtras){
        // Hide product options on main
        if(optWrap) optWrap.classList.add('d-none');
        // Hide combo optional column on main, keep compulsory visible
        if(optCol) optCol.classList.add('d-none');
      } else {
        // If no extras, keep default visibility
        if(optWrap) optWrap.classList.toggle('d-none', !(data.options && data.options.length));
        if(optCol) optCol.classList.remove('d-none');
      }
    }
  }

  // Tab click handler
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('#cfg-tabbar [data-cfg-tab]');
    if(!btn) return;
    cfgTab = btn.getAttribute('data-cfg-tab');
    syncConfigTabs();
  });

  function enforceComboFreeLimit(data){
    if(!data.free_optional_count) return;
    const chosen=[...cfg.optionalSelected];
    if(chosen.length<=data.free_optional_count) return;
    const extras=chosen.slice(data.free_optional_count);
    extras.forEach(code=>{ const input=document.querySelector(`[data-combo-opt='${code}']`); if(input){ input.checked=false; cfg.optionalSelected.delete(code);} });
  }

  function updateConfigPrice(){
    if(!cfg.data) return;
    const data=cfg.data; const noteEl=document.getElementById('cfg-price-note');
    let base = data.price_gross;
    let variantObj = null;
    if(cfg.currentVariant){ variantObj = (data.variants||[]).find(v=>v.code==cfg.currentVariant); if(variantObj) base=variantObj.price_gross; }
    let mealApplied = false;
    const mealPriceSpan = document.getElementById('cfg-meal-price');
    let mealCandidate = 0;
    if(cfg.meal){
      // We only apply meal pricing once fries & drink are both selected.
      const haveFries = cfg.fries !== null && cfg.fries !== undefined;
      const haveDrink = cfg.drink !== null && cfg.drink !== undefined;
      if(haveFries && haveDrink){
        // Helper to pick correct price (discounted component price if provided else standard).
        const chosenBurgerStd = variantObj? variantObj.price_gross : data.price_gross;
        const chosenBurgerMeal = variantObj? (variantObj.discounted_price_gross||0) : (data.discounted_price_gross||0);
        // Find fries & drink product objects from meal_components lists.
  const friesList = (data.meal_components?.fries||[]);
  const baseFriesObj = friesList.find(f=> f.code==cfg.fries);
  const goLarge = document.getElementById('cfg-go-large')?.checked;
  // If Go Large, pick the fries entry with the highest price (robust to naming)
  const friesObj = goLarge ? (friesList.slice().sort((a,b)=> (b.price_gross||0)-(a.price_gross||0))[0] || baseFriesObj) : baseFriesObj;
        // Drinks: if Go Large, use the T_DRINK_CD of selected drink (product code of large); else use selected regular
        const allDrinks = (data.meal_components?.drinks||[]);
        const regularDrinkObj = allDrinks.find(d=> d.code==cfg.drink);
        let drinkObj = regularDrinkObj;
        if(goLarge && regularDrinkObj){
          const largeCode = regularDrinkObj.T_DRINK_CD || regularDrinkObj.t_drink_cd || 0;
          if(largeCode){
            const largeObj = allDrinks.find(d=> d.code==largeCode);
            if(largeObj) drinkObj = largeObj;
          }
        }
        const friesStd = friesObj? friesObj.price_gross : 0;
        const drinkStd = drinkObj? drinkObj.price_gross : 0;
        const friesMeal = friesObj? (friesObj.discounted_price_gross||0) : 0;
        const drinkMeal = drinkObj? (drinkObj.discounted_price_gross||0) : 0;
        // If any discounted component price is zero/absent fall back to its standard price.
        const burgerComponent = (chosenBurgerMeal>0? chosenBurgerMeal : chosenBurgerStd);
        const friesComponent = (friesMeal>0? friesMeal : friesStd);
        const drinkComponent = (drinkMeal>0? drinkMeal : drinkStd);
        mealCandidate = burgerComponent + friesComponent + drinkComponent;
        base = mealCandidate; // effective base becomes sum of discounted components
        mealApplied = true;
        // Savings vs paying individually (all standard or variant standard)
        const singlesTotal = chosenBurgerStd + friesStd + drinkStd;
        const savings = singlesTotal - mealCandidate;
        noteEl.textContent = savings>0 ? `Meal price applied (save £${(savings/100).toFixed(2)})` : 'Meal price applied';
      } else {
        noteEl.textContent = 'Select fries & drink to apply meal price';
      }
    } else {
      noteEl.textContent='';
    }
    // Add option prices (product options always add full price; combo optional add after free allowance)
    if(data.type==='product'){
      (data.options||[]).forEach(o=>{ if(cfg.optionalSelected.has(o.code)){ base += o.price_gross; } });
    } else if(data.type==='combo'){
      const chosen = (data.optional||[]).filter(o=>cfg.optionalSelected.has(o.code));
      // Always charge for selected combo optionals
      chosen.forEach(o=>{ base += (o.price_gross||0); });
    }
    cfg.effectivePrice = base;
    document.getElementById('cfg-price-main').textContent = money(base);
    // Show potential meal candidate + savings if applicable
    if(cfg.meal){
      if(mealApplied){
        const chosenBurgerStd = variantObj? variantObj.price_gross : data.price_gross;
        const friesObj = (data.meal_components?.fries||[]).find(f=> f.code==cfg.fries);
        const drinkObj = (data.meal_components?.drinks||[]).find(d=> d.code==cfg.drink);
        const singlesTotal = (chosenBurgerStd||0) + (friesObj?.price_gross||0) + (drinkObj?.price_gross||0);
        const savings = singlesTotal - mealCandidate;
        mealPriceSpan.textContent = `(Meal £${(mealCandidate/100).toFixed(2)}${savings>0? ' save £'+(savings/100).toFixed(2):''})`;
      } else if(mealCandidate>0){
        mealPriceSpan.textContent = `(Meal £${(mealCandidate/100).toFixed(2)} pending)`;
      } else {
        mealPriceSpan.textContent='';
      }
    } else {
      mealPriceSpan.textContent='';
    }
    // Gate Add button
    const addBtn = document.getElementById('cfg-add-btn');
    if(cfg.meal){
      const ready = mealApplied; // apply rule: require fries & drink so meal applied
      addBtn.disabled = !ready;
    } else {
      addBtn.disabled = false;
    }
  }

  document.getElementById('cfg-add-btn').addEventListener('click', ()=>{
    if(!cfg.data) return;
    // Build display-friendly choice labels
    const displayChoices = [];
    const baseData = cfg.data;
    // Compute effective fries/drink codes based on Go Large state
    let effectiveFries = cfg.fries;
    let effectiveDrink = cfg.drink;
    const goLarge = document.getElementById('cfg-go-large')?.checked;
    if(cfg.meal){
      const friesList = (baseData.meal_components?.fries||[]);
      if(goLarge){
        const baseFriesObj = friesList.find(f=> f.code==cfg.fries);
        const largeFriesObj = friesList.find(f=> /large/i.test(String(f.name||'')));
        effectiveFries = (largeFriesObj?.code) || (baseFriesObj?.code) || cfg.fries;
      }
      const drinksList = (baseData.meal_components?.drinks||[]);
      const selDrink = drinksList.find(d=> d.code==cfg.drink);
      if(goLarge && selDrink){
        const largeCode = selDrink.T_DRINK_CD || selDrink.t_drink_cd || 0;
        if(largeCode) effectiveDrink = largeCode;
      }
    }
    if(cfg.meal){
      if(effectiveFries){
        const friesObj = (baseData.meal_components?.fries||[]).find(f=> f.code==effectiveFries);
        displayChoices.push(`Fries: ${friesObj? friesObj.name : '#'+cfg.fries}`);
      }
      if(effectiveDrink){
        const drinkObj = (baseData.meal_components?.drinks||[]).find(d=> d.code==effectiveDrink);
        displayChoices.push(`Drink: ${drinkObj? drinkObj.name : '#'+cfg.drink}`);
      }
    }
    // Product options
    if(baseData.type==='product'){
      (baseData.options||[]).forEach(o=>{ if(cfg.optionalSelected.has(o.code)) displayChoices.push(`${o.name} ${money(o.price_gross||0)}`); });
    } else if(baseData.type==='combo'){
      (baseData.optional||[]).forEach(o=>{ if(cfg.optionalSelected.has(o.code)) displayChoices.push(`${o.name} ${money(o.price_gross||0)}`); });
    }
    const meta = {
      options: [...cfg.optionalSelected],
  fries: cfg.meal? effectiveFries : null,
  drink: cfg.meal? effectiveDrink : null,
      variant_code: cfg.currentVariant || null,
      display_choices: displayChoices
    };
    addLine({
      code: cfg.currentVariant || cfg.data.code,
      name: cfg.data.name + (cfg.currentVariant? '*':'') + (cfg.meal? ' Meal':''),
      variant: cfg.currentVariant? (cfg.data.variants||[]).find(v=>v.code==cfg.currentVariant)?.label : null,
      meal: cfg.meal,
      price: cfg.effectivePrice,
      type: cfg.data.type,
      meta: { ...meta, meal_applied: cfg.meal }
    });
    cfgModal.hide();
  });

  // VAT basis buttons handler
  basisButtonsWrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-basis]');
    if(!btn) return;
    vatBasis = btn.getAttribute('data-basis') === 'eat' ? 'eat' : 'take';
    [...basisButtonsWrap.querySelectorAll('[data-basis]')].forEach(b=> b.classList.toggle('active', b===btn));
    renderProducts();
  });
  // Band buttons click handler (touch-friendly)
  bandButtonsWrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-band]');
    if(!btn) return;
    const band = btn.getAttribute('data-band');
    if(!band) return;
    currentBand = String(band);
    // Toggle active state
    [...bandButtonsWrap.querySelectorAll('[data-band]')].forEach(b=> b.classList.toggle('active', b===btn));
    activeCategoryId = null; // reset selection on band change
    fetchMenu();
  });
  document.getElementById('toggle-net').addEventListener('change', (e)=>{ showNet = e.target.checked; renderProducts(); });

  // Initial
  fetchMenu();

  function submitOrder(extra){
    if(!basket.lines.length) return;
    checkoutBtn.disabled = true; checkoutBtn.textContent='Saving...';
  const payload = {
      price_band: currentBand,
      vat_basis: vatBasis,
      show_net: showNet,
      payment_method: extra?.payment_method || 'Cash',
      crew_id: extra?.crew_id || '0',
      lines: basket.lines.map(l=>({
        code: l.code,
        type: l.type || 'product',
        name: l.name,
        variant: l.variant,
        meal: !!l.meal,
        qty: l.qty||1,
    price_gross: l.price,
    meta: l.meta || {}
      }))
    };
  fetch('/api/order/submit', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','X-CSRFToken':getCsrf()}, body: JSON.stringify(payload) })
      .then(r=>r.json())
      .then(resp=>{
        if(resp.order_id){
          alert('Order Saved #' + resp.order_id);
          basket.lines=[]; renderBasket();
        } else {
          alert('Save failed: ' + (resp.error||'unknown'));
        }
      })
      .catch(()=>alert('Network error saving order'))
      .finally(()=>{ checkoutBtn.disabled=false; checkoutBtn.textContent='Checkout'; });
  }

  function getCsrf(){
    const m = document.cookie.match(/csrftoken=([^;]+)/); return m? m[1]:'';
  }
})();
</script>
{% endblock %}