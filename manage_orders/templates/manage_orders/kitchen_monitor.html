{% load static %}
<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Kitchen Monitor v2</title>
		<link rel="stylesheet" type="text/css" href="{% static 'bootstrap-5.3.7-dist/css/bootstrap.min.css' %}">
	</head>
	<body>
		<div class="container-fluid px-3 py-3">
			<div class="d-flex justify-content-between align-items-center mb-2">
				<h1 class="h4 m-0">Kitchen Monitor v2</h1>
				<div class="d-flex align-items-center gap-2">
					<input type="text" id="search" class="form-control form-control-sm" placeholder="Search orders/items" style="min-width:240px;">
					<button id="refresh-btn" class="btn btn-sm btn-outline-secondary">Refresh</button>
					<button id="fullscreen-btn" class="btn btn-sm btn-outline-primary">Fullscreen</button>
				</div>
			</div>
			<div id="status" class="small text-muted mb-2"></div>
			<div class="table-responsive">
				<table class="table table-sm table-hover align-middle" id="orders-table">
					<thead class="table-light">
						<tr>
							<th style="width:10%">Order</th>
							<th style="width:10%">Age</th>
							<th>Items</th>
							<th>Notes</th>
						</tr>
					</thead>
					<tbody id="orders-body"></tbody>
				</table>
			</div>
			<div id="last-updated" class="small text-muted mt-2">Loading...</div>
		</div>
		<script src="{% static 'bootstrap-5.3.7-dist/js/bootstrap.bundle.min.js' %}"></script>
		<script>
			const REFRESH_INTERVAL_MS = 10000;
			let refreshTimer = null;
			let cache = [];
			function formatAge(sec){ const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
			function setStatus(msg,isError=false){ const el=document.getElementById('status'); el.textContent=msg; el.classList.toggle('text-danger',isError); el.classList.toggle('text-muted',!isError); }

			// No CSRF or actions needed in this simplified view

			function lineChoicesHtml(l){
				const parts=[];
				if(l && l.meta){
					if(Array.isArray(l.meta.display_choices) && l.meta.display_choices.length){
						return `<ul class='small text-muted mb-0'>${l.meta.display_choices.map(c=>`<li>${c}</li>`).join('')}</ul>`;
					} else {
						if(l.meta.fries) parts.push(`Fries: #${l.meta.fries}`);
						if(l.meta.drink) parts.push(`Drink: #${l.meta.drink}`);
						if(Array.isArray(l.meta.options) && l.meta.options.length){ parts.push(`Options: ${l.meta.options.map(x=>`#${x}`).join(', ')}`); }
						if(parts.length){ return `<ul class='small text-muted mb-0'>${parts.map(x=>`<li>${x}</li>`).join('')}</ul>`; }
					}
				}
				return '';
			}

			function renderRows(list){
				const tbody=document.getElementById('orders-body');
				const q=(document.getElementById('search').value||'').trim().toLowerCase();
				const filtered = list.filter(o=>{
					if(!q) return true;
					const idStr=String(o.id);
					const items=(o.lines||[]).map(l=>`${l.name} ${l.variant||''}`).join(' ').toLowerCase();
					const note=((o.notes||'')+'' ).toLowerCase();
					return idStr.includes(q) || items.includes(q) || note.includes(q);
				});
				tbody.innerHTML='';
				if(!filtered.length){ tbody.innerHTML = `<tr><td colspan="7" class="text-muted">No pending orders.</td></tr>`; return; }
				filtered.forEach(o=>{
					const noteHtml = o.notes ? `<div class='small text-muted mt-1'>${o.notes}</div>` : '';
					const linesHtml = (o.lines||[]).map(l=>{
						const variantHtml = l.variant ? ` <span class='badge bg-secondary'>${l.variant}</span>` : '';
						const mealHtml = l.meal ? ` <span class='badge bg-info text-dark'>Meal</span>` : '';
						return `<div class='mb-1'><span class='fw-semibold'>${l.qty}x</span> ${l.name}${variantHtml}${mealHtml}${lineChoicesHtml(l)}</div>`;
					}).join('');
					const tr=document.createElement('tr');
					tr.innerHTML = `
						<td class="fw-semibold">#${o.id}</td>
						<td><span class='badge ${o.status==='packed'?'text-bg-warning':'bg-danger'} fw-semibold' data-timer='${o.id}' data-age='${o.age_seconds||0}'>--:--</span></td>
						<td>${linesHtml}</td>
						<td>${noteHtml}</td>`;
					tbody.appendChild(tr);
				});
				startTimers();
			}

			function startTimers(){
				document.querySelectorAll('[data-timer]').forEach(el=>{
					if(!el.dataset.ageCurrent){ el.dataset.ageCurrent = String(parseInt(el.dataset.age||'0',10)); }
					el.textContent = formatAge(parseInt(el.dataset.ageCurrent,10));
				});
				if(!window.__kmonv2Timer){ window.__kmonv2Timer = setInterval(()=>{
					document.querySelectorAll('[data-timer]').forEach(el=>{
						let a = parseInt(el.dataset.ageCurrent||'0',10); a = isNaN(a)? 0 : a+1; el.dataset.ageCurrent = String(a); el.textContent = formatAge(a);
					});
				}, 1000); }
			}

			async function fetchPending(){
				setStatus('Loading...');
				try{
					const r = await fetch('/api/orders/pending');
					if(!r.ok) throw new Error('HTTP '+r.status);
					const d = await r.json();
					cache = d.orders || [];
					renderRows(cache);
					document.getElementById('last-updated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
					setStatus('');
				}catch(err){ setStatus('Failed to load: '+err.message, true); }
			}

			function startAuto(){ if(refreshTimer) clearInterval(refreshTimer); refreshTimer=setInterval(fetchPending, REFRESH_INTERVAL_MS); }

			document.getElementById('refresh-btn').addEventListener('click', fetchPending);
			document.getElementById('fullscreen-btn').addEventListener('click', () => { const docEl=document.documentElement; if(!document.fullscreenElement){ docEl.requestFullscreen?.(); } else { document.exitFullscreen?.(); } });
			document.getElementById('search').addEventListener('input', ()=> renderRows(cache));
			// No row actions in simplified view

			// Initial
			fetchPending(); startAuto();
		</script>
	</body>
	</html>